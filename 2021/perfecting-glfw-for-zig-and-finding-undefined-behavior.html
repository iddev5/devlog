<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Perfecting GLFW for Zig, and finding lurking undefined behavior that went unnoticed for 6+ years</title>
  <meta name="description" content="Today, I am announcing mach-glfw: Ziggified GLFW bindings with 100% API coverage, zero-fuss installation, cross compilation, and more.">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="/2021/perfecting-glfw-for-zig-and-finding-undefined-behavior">
  
  
  <link rel="alternate" type="application/rss+xml" title="Hexops&#39; devlog" href="/feed.xml">

  

  
  <meta property="og:title" content="Perfecting GLFW for Zig, and finding lurking undefined behavior that went unnoticed for 6+ years">
  <meta property="og:site_name" content="Hexops&#39; devlog">
  <meta property="og:url" content="/2021/perfecting-glfw-for-zig-and-finding-undefined-behavior">
  <meta property="og:description" content="Today, I am announcing mach-glfw: Ziggified GLFW bindings with 100% API coverage, zero-fuss installation, cross compilation, and more.">
  
  
    <meta property="og:image" content="https://user-images.githubusercontent.com/3173176/139573985-d862f35a-e78e-40c2-bc0c-9c4fb68d6ecd.png">
  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Perfecting GLFW for Zig, and finding lurking undefined behavior tha...">
  <meta name="twitter:description" content="Today, I am announcing mach-glfw: Ziggified GLFW bindings with 100% API coverage, zero-fuss installation, cross compilation, and more.">
  
  
    <meta name="twitter:image:src" content="https://raw.githubusercontent.com/hexops/website/master/media/png/square_logo.png">
  

  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">

  

</head>


  <body>

    <header class="site-header">

    <div class="wrapper">

      <a class="site-title" href="/">
        <img alt="Hexops" class="logo color" src="https://raw.githubusercontent.com/hexops/media/main/logo.svg" style="height: 30px;">' devlog
      </a>
      <link href="/assets/font/stylesheet.css?v2" rel="stylesheet">
      <link rel="icon" sizes="any" type="image/svg+xml" href="https://raw.githubusercontent.com/hexops/website/master/media/svg/icon.svg">

      <script async defer data-domain="devlog.hexops.com" src="https://devlog.hexops.com/assets/opendata.js"></script>

      <nav class="site-nav">
        
          
          <a class="page-link" href="/about">About</a>
        
          
          <a class="page-link" href="/archives">Archives</a>
        
          
          <a class="page-link" href="https://github.com/hexops">GitHub</a>
        
      </nav>
  
    </div>
  
  </header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Perfecting GLFW for Zig, and finding lurking undefined behavior that went unnoticed for 6+ years</h1>
    
    <p class="post-meta"><time datetime="2021-10-31T00:00:00+00:00" itemprop="datePublished">Oct 31, 2021</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Stephen Gutekanst</span></span> •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/mach/">mach,</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
        <a href="/categories/zig/">zig,</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/gamedev/">gamedev,</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/glfw/">glfw</a>
      
    
      
    
      
    
      
    
      
    
  



</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><strong>Today, I am announcing <a href="https://github.com/hexops/mach-glfw">mach-glfw</a>: Ziggified GLFW bindings with 100% API coverage, zero-fuss installation, cross compilation, and more.</strong></p>

<h2 id="building-mach-for-everyone">Building Mach for everyone</h2>

<p>If <a href="https://github.com/hexops/mach">Mach engine</a> only benefits people interested in using that engine, and not the broader Zig (and even gamedev) community I would consider that <em>a total failure</em>.</p>

<p>Whether you’re interested in using all of Mach, just some of it with your own engine / project, or just the tools/ideas we develop in the future (with Unity, Unreal, etc.), <em>I truly aim to produce something that benefits you</em>.</p>

<p>Mach is in super early stages, I’ve spent the last four months perfecting a Zig interface to GLFW, and making no-fuss installation and cross-compilation a reality. Today, you can benefit from that work too.</p>

<h2 id="building-glfw-for-every-platform">Building GLFW for every platform</h2>

<p>Just <code class="language-plaintext highlighter-rouge">zig</code> and <code class="language-plaintext highlighter-rouge">git</code>, that’s the idea. The GLFW C code is compiled with <code class="language-plaintext highlighter-rouge">zig</code>, and the <code class="language-plaintext highlighter-rouge">build.zig</code> file automatically uses <code class="language-plaintext highlighter-rouge">git</code> to clone (a very minimal set of) system dependencies for you (X11 libraries, etc.)</p>

<p>No installing apt packages. No dealing with missing header errors. It should just work out-of-the-box, and for every platform:</p>

<p><a href="https://user-images.githubusercontent.com/3173176/137650099-cd370046-eb43-4fe4-a72a-f54ebe3153c1.png"><img alt="Mach engine platform support, including Windows, Linux, Mac and cross-compilation between them with Android/iOS coming soon." class="color" src="https://user-images.githubusercontent.com/3173176/137650099-cd370046-eb43-4fe4-a72a-f54ebe3153c1.png" /></a></p>

<p>Today, this works for GLFW itself. Cross-compilation of <em>OpenGL and Vulkan apps</em> is not yet fully functional. <a href="https://github.com/hexops/mach/issues/59">We’re working on it, though.</a></p>

<h2 id="perfecting-glfw-for-zig">Perfecting GLFW for Zig</h2>

<p>Aside from platform support, mach-glfw now has:</p>

<ul>
  <li><strong>100% API coverage</strong> of GLFW v3.3.4. Every function, type, constant, etc. has been wrapped in a ziggified API.</li>
  <li><strong>130+ tests</strong>, with CI testing Linux, Windows, Mac (x86 and M1/ARM) and cross-compilation between them.</li>
</ul>

<p>You might be asking: <em>why Zig bindings, when Zig can interface directly with C?</em> Ziggified bindings to GLFW get us:</p>

<ul>
  <li>Errors as <a href="https://ziglang.org/documentation/master/#Errors">zig errors</a> instead of via a callback function.</li>
  <li><strong>Enums</strong>: always know what value a GLFW function can accept as everything is strictly typed. And use the nice Zig syntax to access enums, like <code class="language-plaintext highlighter-rouge">window.getKey(.escape)</code> instead of <code class="language-plaintext highlighter-rouge">c.glfwGetKey(window, c.GLFW_KEY_ESCAPE)</code></li>
  <li>Slices instead of C pointers and lengths.</li>
  <li><a href="https://ziglang.org/documentation/master/#packed-struct">packed structs</a> represent bit masks, so you can use <code class="language-plaintext highlighter-rouge">if (joystick.down and joystick.right)</code> instead of <code class="language-plaintext highlighter-rouge">&amp;</code> <code class="language-plaintext highlighter-rouge">|</code> etc. bitwise operators.</li>
  <li><code class="language-plaintext highlighter-rouge">true</code> and <code class="language-plaintext highlighter-rouge">false</code> instead of <code class="language-plaintext highlighter-rouge">c.GLFW_TRUE</code> and <code class="language-plaintext highlighter-rouge">c.GLFW_FALSE</code>.</li>
  <li>Generics: use <code class="language-plaintext highlighter-rouge">window.hint</code> instead of <code class="language-plaintext highlighter-rouge">glfwWindowHint</code>, <code class="language-plaintext highlighter-rouge">glfwWindowHintString</code>, etc.</li>
  <li>Methods, e.g. <code class="language-plaintext highlighter-rouge">my_window.hint(...)</code> instead of <code class="language-plaintext highlighter-rouge">glfwWindowHint(my_window, ...)</code></li>
</ul>

<h2 id="explicit-error-handling-solves-a-real-problem">Explicit error handling solves a real problem</h2>

<p>GLFW traditionally passes errors to the user via a callback. This can make errors easy to ignore, as well as difficult to correlate and handle effectively at the time of the function invocation.</p>

<p>We translated a <a href="https://github.com/hexops/mach-glfw-vulkan-example">a Vulkan example to mach-glfw</a>, which you can try for yourself today:</p>

<p><a href="https://user-images.githubusercontent.com/3173176/139573985-d862f35a-e78e-40c2-bc0c-9c4fb68d6ecd.png"><img alt="mach-glfw and vulkan-zig libraries working together to produce a triangle." class="color" src="https://user-images.githubusercontent.com/3173176/139573985-d862f35a-e78e-40c2-bc0c-9c4fb68d6ecd.png" /></a></p>

<p>After porting it, we found that the example was crashing with a <code class="language-plaintext highlighter-rouge">NoWindowContext</code> error. Strange?</p>

<p>As it turns out, we had found <a href="https://github.com/Snektron/vulkan-zig/pull/21">a small bug in the vulkan-zig example code</a>, it was calling <code class="language-plaintext highlighter-rouge">glfwSwapBuffers</code> which is not needed for Vulkan. The error went unnoticed because it’s easy to miss errors with GLFW’s error callback handling style. But with mach-glfw, it was an explicit error you have to handle e.g. via <code class="language-plaintext highlighter-rouge">try glfw.swapBuffers()</code> - we literally couldn’t miss it.</p>

<h2 id="finding-lurking-undefined-behavior-in-6-year-old-glfw-code">Finding lurking undefined behavior in 6+ year old GLFW code</h2>

<p>One <em>particularly frustrating</em> issue was tracking down why the last part of the GLFW API we needed to wrap for 100% coverage, the <code class="language-plaintext highlighter-rouge">glfwSetWindowIcon</code> function, was crashing:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Test [76/135] Window.test "setIcon"... Illegal instruction at address 0x2cee09
upstream/glfw/src/x11_window.c:0:0: 0x2cee09 in _glfwPlatformSetWindowIcon (/mach/glfw/upstream/glfw/src/x11_window.c)
upstream/glfw/src/window.c:511:5: 0x2de484 in glfwSetWindowIcon (/mach/glfw/upstream/glfw/src/window.c)
    _glfwPlatformSetWindowIcon(window, count, images);
    ^
/mach/glfw/src/Window.zig:508:28: 0x23a083 in Window.test "setIcon" (test)
        c.glfwSetWindowIcon(self.handle, @intCast(c_int, im.len), &amp;tmp[0]);
                           ^
/usr/local/bin/lib/std/special/test_runner.zig:77:28: 0x25a0d1 in std.special.main (test)
        } else test_fn.func();
                           ^
/usr/local/bin/lib/std/start.zig:517:22: 0x2896bc in std.start.callMain (test)
            root.main();
                     ^
/usr/local/bin/lib/std/start.zig:469:12: 0x25c117 in std.start.callMainWithArgs (test)
    return @call(.{ .modifier = .always_inline }, callMain, .{});
           ^
/usr/local/bin/lib/std/start.zig:434:12: 0x25bec2 in std.start.main (test)
    return @call(.{ .modifier = .always_inline }, callMainWithArgs, .{ @intCast(usize, c_argc), c_argv, envp });
           ^
???:?:?: 0x7f4b7c3280b2 in ??? (???)
</code></pre></div></div>

<p>That’s odd? <code class="language-plaintext highlighter-rouge">Illegal instruction at address 0x2cee09</code> - are we corrupting the stack somehow? Is this a Zig compiler bug?</p>

<p>Running in <code class="language-plaintext highlighter-rouge">lldb</code> didn’t help with shining any light on the problem, either:</p>

<p><a href="https://user-images.githubusercontent.com/3173176/139576146-775371fd-8003-46ba-aa30-8b81a2f22ce0.png"><img alt="lldb showing nothing particularly useful" class="color" src="https://user-images.githubusercontent.com/3173176/139576146-775371fd-8003-46ba-aa30-8b81a2f22ce0.png" /></a></p>

<p>After poking around at the stack, checking all pointers and lengths were valid, etc. I was at a loss. The mach-glfw code <em>sure seemed valid</em>, and yet, this crash. I managed to track the crash down to the first iteration of a loop in GLFW’s <code class="language-plaintext highlighter-rouge">x11_window.c</code>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">_glfwSetWindowIconX11</span><span class="p">(</span><span class="n">_GLFWwindow</span><span class="o">*</span> <span class="n">window</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="n">GLFWimage</span><span class="o">*</span> <span class="n">images</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">longCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span>  <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">longCount</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span> <span class="o">*</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>

        <span class="kt">long</span><span class="o">*</span> <span class="n">icon</span> <span class="o">=</span> <span class="n">_glfw_calloc</span><span class="p">(</span><span class="n">longCount</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
        <span class="kt">long</span><span class="o">*</span> <span class="n">target</span> <span class="o">=</span> <span class="n">icon</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span>  <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="o">*</span><span class="n">target</span><span class="o">++</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span><span class="p">;</span>
            <span class="o">*</span><span class="n">target</span><span class="o">++</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">j</span> <span class="o">&lt;</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span> <span class="o">*</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>  <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// illegal instruction on first iteration?</span>
                <span class="o">*</span><span class="n">target</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixels</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
                            <span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixels</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
                            <span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixels</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
                            <span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixels</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
<span class="p">...</span>
</code></pre></div></div>

<h2 id="reaching-my-limits">Reaching my limits</h2>

<p>At this point, I feel confident in saying:</p>

<ul>
  <li>The Zig code is correct, the pointers are valid, the lengths are correct, everything’s right.</li>
  <li>The GLFW code is pretty popular, and it’s been around for 6 years. Seems unlikely it’s a bug in GLFW?</li>
</ul>

<p>Luckily, my brother (and reverse engineer) <a href="https://github.com/Andoryuuta">@Andoryuuta</a> was available to help debug, so I pulled him in. Stepping through instructions, we could see clearly that after a bit shift we were stepping into the abyss:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* thread #1, name = 'test', stop reason = instruction step over
    frame #0: 0x00000000002c6f84 test`_glfwPlatformSetWindowIcon(window=0x00000000004e53d0, count=1, images=0x00007fffec0b3000) at x11_window.c:2156:58
   2153	                *target++ = (images[i].pixels[j * 4 + 0] &lt;&lt; 16) |
   2154	                            (images[i].pixels[j * 4 + 1] &lt;&lt;  8) |
   2155	                            (images[i].pixels[j * 4 + 2] &lt;&lt;  0) |
-&gt; 2156	                            (images[i].pixels[j * 4 + 3] &lt;&lt; 24);
   2157	                printf("DID WE GET HERE???x\n");
   2158	            }
   2159	        }
(lldb) 
Process 6516 stopped
* thread #1, name = 'test', stop reason = instruction step over
    frame #0: 0x00000000002c6c21 test`_glfwPlatformSetWindowIcon(window=0x00000000004e53d0, count=1, images=0x00007fffec0b3000) at x11_window.c:0
   1   	//========================================================================
   2   	// GLFW 3.3 X11 - www.glfw.org
   3   	//------------------------------------------------------------------------
   4   	// Copyright (c) 2002-2006 Marcus Geelnard
   5   	// Copyright (c) 2006-2019 Camilla Löwy &lt;elmindreda@glfw.org&gt;
   6   	//
   7   	// This software is provided 'as-is', without any express or implied
(lldb) 
Process 6516 stopped
</code></pre></div></div>

<p>Inspecting the binary in IDA Pro we were able to see that we were jumping into an <code class="language-plaintext highlighter-rouge">__asm { ud1 }</code> section (ud1 standing for “undefined instruction 1”):</p>

<p><a href="https://user-images.githubusercontent.com/3173176/139594073-b2159e4c-6764-44b1-882d-802724f424e8.png"><img alt="IDA Pro showing a jump to an undefined instruction 1" class="color" src="https://user-images.githubusercontent.com/3173176/139594073-b2159e4c-6764-44b1-882d-802724f424e8.png" /></a></p>

<p>It turns out that clang’s UBSan inserts these instructions as traps for when the compiler thinks there is undefined behavior occurring, such as if a pointer addition leads to an overflow. This is super interesting, but unfortunately doesn’t always give a compiler error. We got lucky and found someone else who ran into this through Google:</p>

<blockquote>
  <p>I <em>believe</em> LLVM explicitly generates a ud2 x86 instruction because "it determined" there's undefined behavior in the C code. So first I wonder which flags you're passing it through zig (i.e. how strict are you being with the settings?)&lt;/p&gt;— Abner (@AbnerCoimbre) <a href="https://twitter.com/AbnerCoimbre/status/1339396987100168192">December 17, 2020</a></p>
</blockquote>

<p>And indeed, compiling via <code class="language-plaintext highlighter-rouge">zig build test -Drelease-fast</code> (which turns off UBsan) made the crash go away. So where’s the undefined behavior?</p>

<p>If we squint at the code and assume all pointers, counts, and indices are correct, you might be able to spot it:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">_glfwSetWindowIconX11</span><span class="p">(</span><span class="n">_GLFWwindow</span><span class="o">*</span> <span class="n">window</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="n">GLFWimage</span><span class="o">*</span> <span class="n">images</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
        <span class="kt">long</span><span class="o">*</span> <span class="n">target</span> <span class="o">=</span> <span class="n">icon</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span>  <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="p">...</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">j</span> <span class="o">&lt;</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span> <span class="o">*</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>  <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// illegal instruction on first iteration?</span>
                <span class="o">*</span><span class="n">target</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixels</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
                            <span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixels</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
                            <span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixels</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
                            <span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixels</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
<span class="p">...</span>
</code></pre></div></div>

<p>What is happening here is that:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">images[i].pixels[j * 4 + 0]</code> is returning an <code class="language-plaintext highlighter-rouge">unsigned char</code> (8 bits)</li>
  <li><del>It is then being shifted left by <code class="language-plaintext highlighter-rouge">&lt;&lt; 16</code> bits. !!! That’s further than an 8-bit number can be shifted left by, so that’s UB</del>
    <ul>
      <li>EDIT: Actually, it turns out that’s not exactly right, it’s the <code class="language-plaintext highlighter-rouge">&lt;&lt; 24</code> that’s the cause of the UB, thanks <a href="https://github.com/Maato">@Maato</a> for <a href="https://github.com/glfw/glfw/pull/1986#issuecomment-955784179">pointing this out and explaining in better detail than I could</a>.</li>
    </ul>
  </li>
</ul>

<p>Suddenly, it all makes sense. And <a href="https://godbolt.org/z/ddq75WsYK">if we load an equal snippet of code into Godbolt</a> we can see what is happening when we compile without UBSan / the <code class="language-plaintext highlighter-rouge">-fsanitize=undefined</code> flag:</p>

<p><a href="https://user-images.githubusercontent.com/3173176/139594650-eff35347-3f32-42e5-bc60-da2a1dceb1e1.png"><img alt="Compilation with godbolt with UBSan turned off shows movement into 32-bit EAX register" class="color" src="https://user-images.githubusercontent.com/3173176/139594650-eff35347-3f32-42e5-bc60-da2a1dceb1e1.png" /></a></p>

<p>Without UBsan, clang merely uses the 32-bit EAX register as an optimization. It loads the 8-bit number into the 32-bit register, and then performs the left shift. Although the shift exceeds 8 bits, it <em>does not get truncated to zero</em> - instead it is effectively as if the number was converted to a <code class="language-plaintext highlighter-rouge">long</code> (32 bits) prior to the left-shift operation.</p>

<p>This explains why nobody has caught this UB in GLFW yet, too: it works by accident! Just because the compiler likes to use 32-bit registers in this context.</p>

<p>And this change benefits all the languages out there using GLFW: <a href="https://github.com/glfw/glfw/pull/1986">glfw/glfw#1986</a></p>

<h2 id="defaults-are-critical">Defaults are <em>critical</em></h2>

<p>This code, and undefined behavior, has been in GLFW for over 6 years according to <code class="language-plaintext highlighter-rouge">git blame</code>.</p>

<p>Anybody using GLFW <em>could have</em> enabled UBSan in their C compiler. Anybody <em>could have</em> run into this same crash and debugged it in the last 6 years. But they didn’t.</p>

<p>In mach-glfw, we compile all of GLFW’s C code with Zig (which is also a fully functional C and C++ compiler), with UBSan enabled by default.</p>

<p>Only because Zig has good defaults, because it places so much emphasis on things being right <em>out of the box</em>, and because there is such an emphasis on having safety checks for undefined behavior - were we able to catch this undefined behavior that went unnoticed in GLFW for the last 6 years.</p>

<h2 id="thanks-for-reading">Thanks for reading</h2>

<p>All key Mach engine developments will be posted here, with incremental updates on Twitter <a href="https://twitter.com/machengine">@machengine</a>.</p>

<p>Follow <a href="https://github.com/hexops/mach">Mach engine on GitHub</a>, and if you like what I’m doing please consider <a href="https://github.com/sponsors/slimsag">sponsoring my work</a>.</p>

  </div>

  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      <a alt="Twitter" href="https://twitter.com/slimsag""><img src="https://shields.io/badge/Twitter-follow-blue?logo=Twitter" class="color"></a>
&nbsp;
<a alt="RSS Follow" href="/feed.xml""><img src="https://shields.io/badge/RSS-follow-green?logo=RSS" class="color"></a>
&nbsp;
<a alt="License: CC BY 4.0" href="https://creativecommons.org/licenses/by/4.0"><img src="https://img.shields.io/badge/License-CC%20BY%204.0-lightgrey.svg" class="color"></a>
&nbsp;
<a alt="Hexops on GitHub" href="https://github.com/hexops" class="github color" style="background-image: url(https://raw.githubusercontent.com/simple-icons/simple-icons/develop/icons/github.svg);line-height: 1;padding-left: 1.5rem;background-repeat: no-repeat;padding-top: .25rem;"> GitHub</a>
<br>
<br>
<a href="https://hexops.com"><img class="logo color" height="50px" alt="Hexops logo" src="https://raw.githubusercontent.com/hexops/media/main/logo.svg"></a>
<br>


&copy;  2021 Hexops
<link rel="me" href="mailto:support@hexops.com">
    </p>

  </div>

</footer>


  </body>

</html>
